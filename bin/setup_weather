#!/bin/bash

# Weather Widget Setup Script
# Helps configure the weather widget with API key and location

CONFIG_DIR="$HOME/.config/awesome"
ENV_FILE="$CONFIG_DIR/.env"
ENV_EXAMPLE="$CONFIG_DIR/.env.example"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🌤️  Weather Widget Setup${NC}"
echo "=================================="

# Check if .env already exists
if [ -f "$ENV_FILE" ]; then
    echo -e "${YELLOW}Warning: .env file already exists${NC}"
    echo "Current configuration:"
    echo ""
    grep -E "^WEATHER_" "$ENV_FILE" | sed 's/^/  /'
    echo ""
    read -p "Do you want to update it? (y/N): " update_choice
    if [[ ! "$update_choice" =~ ^[Yy]$ ]]; then
        echo "Setup cancelled."
        exit 0
    fi
else
    # Copy example file
    if [ -f "$ENV_EXAMPLE" ]; then
        cp "$ENV_EXAMPLE" "$ENV_FILE"
        echo -e "${GREEN}Created .env file from example${NC}"
    else
        echo -e "${RED}Error: .env.example not found${NC}"
        exit 1
    fi
fi

echo ""
echo "Please provide the following information:"
echo ""

# Get API Key
echo -e "${BLUE}1. OpenWeatherMap API Key${NC}"
echo "   Get your free API key at: https://openweathermap.org/api"
read -p "   Enter your API key: " api_key

if [ -z "$api_key" ]; then
    echo -e "${RED}Error: API key is required${NC}"
    exit 1
fi

# Get Location
echo ""
echo -e "${BLUE}2. Location Coordinates${NC}"
echo "   You can get coordinates from Google Maps:"
echo "   - Right-click on your location"
echo "   - Click on the coordinates that appear"
echo ""

read -p "   Enter latitude (e.g., -16.823): " latitude
read -p "   Enter longitude (e.g., -49.244): " longitude

if [ -z "$latitude" ] || [ -z "$longitude" ]; then
    echo -e "${RED}Error: Both latitude and longitude are required${NC}"
    exit 1
fi

# Optional: City name
echo ""
echo -e "${BLUE}3. Optional: City Information${NC}"
read -p "   Enter city name (optional): " city
read -p "   Enter country code (e.g., BR, US): " country

# Update .env file
echo ""
echo -e "${YELLOW}Updating .env file...${NC}"

# Create temporary file with new values
cat > "$ENV_FILE" << EOF
# Weather Widget Configuration
# OpenWeatherMap API Configuration
WEATHER_API_KEY=$api_key
WEATHER_LATITUDE=$latitude
WEATHER_LONGITUDE=$longitude

# Optional: City name for display
WEATHER_CITY=${city:-Unknown City}
WEATHER_COUNTRY_CODE=${country:-BR}
EOF

echo -e "${GREEN}✅ Configuration saved to .env${NC}"
echo ""
echo "Configuration summary:"
echo "  API Key: ${api_key:0:8}..."
echo "  Location: $latitude, $longitude"
echo "  City: ${city:-Unknown City}"
echo "  Country: ${country:-BR}"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "1. Restart AwesomeWM (Super + Ctrl + r)"
echo "2. The weather widget should now show real data"
echo "3. Click on the weather widget to refresh"
echo ""
echo -e "${GREEN}Setup completed!${NC}"
