#!/bin/bash

# Picom Watchdog - Keeps Picom always running
# Monitors Picom process and restarts if it stops

PICOM_MANAGER="$HOME/.config/awesome/bin/picom_manager"
LOG_FILE="$HOME/.config/awesome/picom_watchdog.log"
CHECK_INTERVAL=10  # Check every 10 seconds

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check if picom is running
is_picom_running() {
    pgrep -x picom > /dev/null
}

# Send notification via awesome-client
notify() {
    local title="$1"
    local text="$2"
    echo "
    local naughty = require('naughty')
    naughty.notify({
        title = '$title',
        text = '$text',
        timeout = 3
    })
    " | awesome-client 2>/dev/null
}

log "Picom Watchdog started"

# Main monitoring loop
while true; do
    if ! is_picom_running; then
        log "Picom not running, attempting to restart..."
        notify "ðŸŽ­ Picom Watchdog" "Compositor stopped, restarting..."
        
        # Try to start picom
        "$PICOM_MANAGER" start >> "$LOG_FILE" 2>&1
        
        # Wait a moment and check if it started
        sleep 2
        if is_picom_running; then
            log "Picom restarted successfully"
            notify "ðŸŽ­ Picom Watchdog" "Compositor restarted successfully"
        else
            log "Failed to restart Picom"
            notify "ðŸŽ­ Picom Error" "Failed to restart compositor"
        fi
    fi
    
    sleep "$CHECK_INTERVAL"
done
